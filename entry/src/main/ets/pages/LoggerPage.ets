import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import type common from '@ohos.app.ability.common';
import { DesignTokens } from '../model/DesignTokens';
import { ColorsInterface } from '../model/TokenInterfaces';
import { ThemeManager } from '../manager/ThemeManager';
import { logger, LogStats, LogEntry, LogLevel } from '../utils/Logger';
import { DataFileTransfer } from '../sync/DataFileTransfer';

interface LevelFilterOption {
  level: LogLevel | null;
  label: string;
}

@Entry
@Component
struct LoggerPage {
  @State logStats: LogStats = { total: 0, debug: 0, info: 0, warn: 0, error: 0 };
  @State isLogExporting: boolean = false;
  @State isDiagnosticExporting: boolean = false;
  @State searchKeyword: string = '';
  @State selectedLevelIndex: number = 0;
  @State displayedLogs: LogEntry[] = [];
  @State enablePersistence: boolean = false;
  @State persistenceIncludeInfo: boolean = false;
  @State persistenceMaxMB: number = 2;
  @StorageProp('ThemeRefreshToken') @Watch('onThemeChange') themeRefreshToken: number = 0;
  @State private colors: ColorsInterface = ThemeManager.getInstance().getColors();

  private readonly PREVIEW_COUNT = 100;
  private readonly PERSISTENCE_MB_OPTIONS: number[] = [1, 2, 3, 4, 5];
  private readonly LEVEL_FILTERS: LevelFilterOption[] = [
    { level: null, label: 'å…¨éƒ¨' },
    { level: LogLevel.ERROR, label: 'é”™è¯¯' },
    { level: LogLevel.WARN, label: 'è­¦å‘Š' },
    { level: LogLevel.INFO, label: 'ä¿¡æ¯' },
    { level: LogLevel.DEBUG, label: 'è°ƒè¯•' }
  ];

  private onThemeChange(): void {
    this.colors = ThemeManager.getInstance().getColors();
  }

  private refreshDisplayedLogs(): void {
    const filter = this.LEVEL_FILTERS[this.selectedLevelIndex];
    if (this.searchKeyword.length > 0) {
      this.displayedLogs = logger.searchLogs(this.searchKeyword, filter.level ?? undefined)
        .slice(-this.PREVIEW_COUNT);
    } else if (filter.level !== null) {
      this.displayedLogs = logger.getLogsByLevel(filter.level).slice(-this.PREVIEW_COUNT);
    } else {
      this.displayedLogs = logger.getRecentLogs(this.PREVIEW_COUNT);
    }
    this.logStats = logger.getStats();
    this.enablePersistence = logger.isPersistenceEnabled();
    this.persistenceIncludeInfo = logger.getPersistenceIncludeInfo();
    this.persistenceMaxMB = logger.getPersistenceMaxBytesInMB();
  }

  private updatePersistenceEnabled(value: boolean): void {
    this.enablePersistence = value;
    const context = getContext(this) as common.UIAbilityContext;
    logger.setEnablePersistence(value, context);
  }

  private updatePersistenceIncludeInfo(value: boolean): void {
    this.persistenceIncludeInfo = value;
    const context = getContext(this) as common.UIAbilityContext;
    logger.setPersistenceIncludeInfo(value, context);
  }

  private updatePersistenceCapacity(index: number): void {
    const clamped = Math.max(0, Math.min(index, this.PERSISTENCE_MB_OPTIONS.length - 1));
    this.persistenceMaxMB = this.PERSISTENCE_MB_OPTIONS[clamped];
    const context = getContext(this) as common.UIAbilityContext;
    logger.setPersistenceMaxBytesInMB(this.persistenceMaxMB, context);
  }

  private formatTimestamp(ts: number): string {
    const d = new Date(ts);
    const pad = (n: number): string => String(n).padStart(2, '0');
    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  private getLevelBadge(level: LogLevel): string {
    switch (level) {
      case LogLevel.DEBUG: return 'D';
      case LogLevel.INFO: return 'I';
      case LogLevel.WARN: return 'W';
      case LogLevel.ERROR: return 'E';
      default: return '?';
    }
  }

  private getLevelColor(level: LogLevel): ResourceColor {
    switch (level) {
      case LogLevel.DEBUG: return this.colors.GRAY_500;
      case LogLevel.INFO: return this.colors.PRIMARY;
      case LogLevel.WARN: return '#F59E0B';
      case LogLevel.ERROR: return this.colors.ERROR;
      default: return this.colors.GRAY_500;
    }
  }

  private makeLogFileName(): string {
    const d = new Date();
    const pad = (n: number): string => String(n).padStart(2, '0');
    const y = d.getFullYear();
    const m = pad(d.getMonth() + 1);
    const day = pad(d.getDate());
    const hh = pad(d.getHours());
    const mm = pad(d.getMinutes());
    return `vignette_logs_${y}${m}${day}_${hh}${mm}.txt`;
  }

  private makeDiagnosticFileName(): string {
    const d = new Date();
    const pad = (n: number): string => String(n).padStart(2, '0');
    const y = d.getFullYear();
    const m = pad(d.getMonth() + 1);
    const day = pad(d.getDate());
    const hh = pad(d.getHours());
    const mm = pad(d.getMinutes());
    return `vignette_diagnostic_${y}${m}${day}_${hh}${mm}.txt`;
  }

  private async exportLogs(): Promise<void> {
    if (this.isLogExporting) return;
    this.isLogExporting = true;
    logger.info('Logger', 'å¼€å§‹å¯¼å‡ºæ—¥å¿—');
    try {
      const context = getContext(this) as common.UIAbilityContext;
      const logText = logger.exportToText();
      const saveRes = await DataFileTransfer.saveJsonToPickedFile(context, this.makeLogFileName(), logText);
      if (saveRes.ok) {
        promptAction.showToast({ message: 'æ—¥å¿—å·²å¯¼å‡º', duration: 1500 });
        logger.info('Logger', 'æ—¥å¿—å¯¼å‡ºæˆåŠŸ');
      } else if (saveRes.cancelled) {
        promptAction.showToast({ message: 'å·²å–æ¶ˆå¯¼å‡º', duration: 1500 });
        logger.info('Logger', 'æ—¥å¿—å¯¼å‡ºå–æ¶ˆ');
      } else {
        promptAction.showToast({ message: `å¯¼å‡ºå¤±è´¥: ${saveRes.error}`, duration: 2000 });
        logger.error('Logger', 'æ—¥å¿—å¯¼å‡ºå¤±è´¥', saveRes.error);
      }
    } catch (e) {
      const errMsg = e instanceof Error ? e.message : String(e);
      promptAction.showToast({ message: `å¯¼å‡ºå¤±è´¥: ${errMsg}`, duration: 2000 });
      logger.error('Logger', 'æ—¥å¿—å¯¼å‡ºå¼‚å¸¸', errMsg);
    } finally {
      this.isLogExporting = false;
    }
  }

  private async exportDiagnostic(): Promise<void> {
    if (this.isDiagnosticExporting) return;
    this.isDiagnosticExporting = true;
    logger.info('Logger', 'å¼€å§‹ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š');
    try {
      const context = getContext(this) as common.UIAbilityContext;
      const report = logger.generateDiagnosticReport();
      const saveRes = await DataFileTransfer.saveJsonToPickedFile(context, this.makeDiagnosticFileName(), report);
      if (saveRes.ok) {
        promptAction.showToast({ message: 'è¯Šæ–­æŠ¥å‘Šå·²å¯¼å‡º', duration: 1500 });
        logger.info('Logger', 'è¯Šæ–­æŠ¥å‘Šå¯¼å‡ºæˆåŠŸ');
      } else if (saveRes.cancelled) {
        promptAction.showToast({ message: 'å·²å–æ¶ˆå¯¼å‡º', duration: 1500 });
      } else {
        promptAction.showToast({ message: `å¯¼å‡ºå¤±è´¥: ${saveRes.error}`, duration: 2000 });
        logger.error('Logger', 'è¯Šæ–­æŠ¥å‘Šå¯¼å‡ºå¤±è´¥', saveRes.error);
      }
    } catch (e) {
      const errMsg = e instanceof Error ? e.message : String(e);
      promptAction.showToast({ message: `å¯¼å‡ºå¤±è´¥: ${errMsg}`, duration: 2000 });
      logger.error('Logger', 'è¯Šæ–­æŠ¥å‘Šå¯¼å‡ºå¼‚å¸¸', errMsg);
    } finally {
      this.isDiagnosticExporting = false;
    }
  }

  private clearLogs(): void {
    logger.clearLogs();
    this.refreshDisplayedLogs();
    promptAction.showToast({ message: 'æ—¥å¿—å·²æ¸…ç©º', duration: 1500 });
  }

  aboutToAppear(): void {
    this.refreshDisplayedLogs();
    logger.info('Logger', 'è¿›å…¥æ—¥å¿—é¡µé¢');
  }

  @Builder
  private buildHeader() {
    Row() {
      Text('â†')
        .fontSize(DesignTokens.Typography.FONT_SIZE_2XL)
        .fontColor(this.colors.GRAY_900)
        .onClick(() => { router.back(); })

      Text('æ—¥å¿—ä¸è°ƒè¯•')
        .fontSize(DesignTokens.Typography.FONT_SIZE_XL)
        .fontWeight(DesignTokens.Typography.FONT_WEIGHT_BOLD)
        .fontColor(this.colors.GRAY_900)
        .margin({ left: DesignTokens.Spacing.LG })

      Blank()
    }
    .width('100%')
    .height(56)
    .padding({ left: DesignTokens.Layout.CONTAINER_PADDING, right: DesignTokens.Layout.CONTAINER_PADDING })
    .backgroundColor(this.colors.SURFACE_ELEVATED)
    .shadow({ color: this.colors.SHADOW_LIGHT, radius: 4, offsetX: 0, offsetY: 2 })
  }

  @Builder
  private buildStatsBar() {
    Row() {
      Text(`å…± ${this.logStats.total} æ¡`)
        .fontSize(DesignTokens.Typography.FONT_SIZE_SM)
        .fontColor(this.colors.TEXT_SECONDARY)

      Blank()

      if (this.logStats.error > 0) {
        Text(`é”™è¯¯ ${this.logStats.error}`)
          .fontSize(DesignTokens.Typography.FONT_SIZE_SM)
          .fontColor(this.colors.ERROR)
          .margin({ right: DesignTokens.Spacing.SM })
      }
      if (this.logStats.warn > 0) {
        Text(`è­¦å‘Š ${this.logStats.warn}`)
          .fontSize(DesignTokens.Typography.FONT_SIZE_SM)
          .fontColor('#F59E0B')
      }
    }
    .width('100%')
    .padding({ bottom: DesignTokens.Spacing.SM })
  }

  @Builder
  private buildPersistenceCard() {
    Column() {
      Text('æŒä¹…åŒ–ç­–ç•¥')
        .fontSize(DesignTokens.Typography.FONT_SIZE_BASE)
        .fontWeight(DesignTokens.Typography.FONT_WEIGHT_BOLD)
        .fontColor(this.colors.TEXT_PRIMARY)
        .width('100%')

      Text('é»˜è®¤ä»…è½ç›˜ WARN/ERRORï¼Œå¯åŠ¨æ—¶è‡ªåŠ¨å›æ”¾æœ€è¿‘æ—¥å¿—ç”¨äºå´©æºƒå‰ä¸Šä¸‹æ–‡ã€‚')
        .fontSize(DesignTokens.Typography.FONT_SIZE_SM)
        .fontColor(this.colors.TEXT_SECONDARY)
        .width('100%')
        .margin({ top: 6, bottom: DesignTokens.Spacing.MD })

      Row() {
        Column() {
          Text('å¯ç”¨æ—¥å¿—æŒä¹…åŒ–')
            .fontSize(DesignTokens.Typography.FONT_SIZE_BASE)
            .fontColor(this.colors.TEXT_PRIMARY)
          Text('å†™å…¥æœ¬åœ° JSONLï¼ˆæŒ‰æ—¥æ»šåŠ¨ï¼‰')
            .fontSize(DesignTokens.Typography.FONT_SIZE_SM)
            .fontColor(this.colors.TEXT_TERTIARY)
            .margin({ top: 4 })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)

        Toggle({ type: ToggleType.Switch, isOn: this.enablePersistence })
          .selectedColor(this.colors.PRIMARY)
          .switchPointColor(this.colors.WHITE)
          .onChange((value: boolean) => {
            this.updatePersistenceEnabled(value);
          })
      }
      .width('100%')
      .margin({ bottom: DesignTokens.Spacing.MD })

      Row() {
        Column() {
          Text('åŒ…å« INFO çº§åˆ«')
            .fontSize(DesignTokens.Typography.FONT_SIZE_BASE)
            .fontColor(this.colors.TEXT_PRIMARY)
          Text('å…³é—­æ—¶ä»…æŒä¹…åŒ– WARN/ERRORï¼ˆæ¨èï¼‰')
            .fontSize(DesignTokens.Typography.FONT_SIZE_SM)
            .fontColor(this.colors.TEXT_TERTIARY)
            .margin({ top: 4 })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)

        Toggle({ type: ToggleType.Switch, isOn: this.persistenceIncludeInfo })
          .selectedColor(this.colors.PRIMARY)
          .switchPointColor(this.colors.WHITE)
          .enabled(this.enablePersistence)
          .onChange((value: boolean) => {
            this.updatePersistenceIncludeInfo(value);
          })
      }
      .width('100%')
      .margin({ bottom: DesignTokens.Spacing.MD })

      Text(`æ€»å®¹é‡ä¸Šé™ï¼š${this.persistenceMaxMB} MBï¼ˆè¶…é™è‡ªåŠ¨åˆ é™¤æœ€æ—§æ–‡ä»¶ï¼‰`)
        .fontSize(DesignTokens.Typography.FONT_SIZE_SM)
        .fontColor(this.colors.TEXT_SECONDARY)
        .width('100%')
        .margin({ bottom: 8 })

      Row({ space: 8 }) {
        ForEach(this.PERSISTENCE_MB_OPTIONS, (value: number, index: number) => {
          Text(`${value}MB`)
            .fontSize(DesignTokens.Typography.FONT_SIZE_SM)
            .fontColor(this.persistenceMaxMB === value ? this.colors.WHITE : this.colors.TEXT_PRIMARY)
            .backgroundColor(this.persistenceMaxMB === value ? this.colors.PRIMARY : this.colors.BACKGROUND_SECONDARY)
            .borderRadius(DesignTokens.BorderRadius.FULL)
            .padding({ left: 10, right: 10, top: 6, bottom: 6 })
            .opacity(this.enablePersistence ? 1 : 0.5)
            .onClick(() => {
              if (!this.enablePersistence) {
                return;
              }
              this.updatePersistenceCapacity(index);
            })
        }, (value: number) => String(value))
      }
      .width('100%')
    }
    .width('100%')
    .padding(DesignTokens.Spacing.MD)
    .margin({ bottom: DesignTokens.Spacing.MD })
    .backgroundColor(this.colors.SURFACE_PRIMARY)
    .borderRadius(DesignTokens.BorderRadius.LG)
  }

  @Builder
  private buildFilterTabs() {
    Row({ space: DesignTokens.Spacing.SM }) {
      ForEach(this.LEVEL_FILTERS, (filter: LevelFilterOption, index: number) => {
        Text(filter.label)
          .fontSize(DesignTokens.Typography.FONT_SIZE_SM)
          .fontColor(this.selectedLevelIndex === index ? this.colors.WHITE : this.colors.TEXT_PRIMARY)
          .backgroundColor(this.selectedLevelIndex === index ? this.colors.PRIMARY : this.colors.BACKGROUND_SECONDARY)
          .borderRadius(DesignTokens.BorderRadius.FULL)
          .padding({ left: DesignTokens.Spacing.MD, right: DesignTokens.Spacing.MD, top: 4, bottom: 4 })
          .onClick(() => {
            this.selectedLevelIndex = index;
            this.refreshDisplayedLogs();
          })
      }, (filter: LevelFilterOption) => filter.label)
    }
    .width('100%')
    .justifyContent(FlexAlign.Start)
    .padding({ bottom: DesignTokens.Spacing.SM })
  }

  @Builder
  private buildSearchBar() {
    Row() {
      Text('ğŸ”')
        .fontSize(DesignTokens.Typography.FONT_SIZE_BASE)
        .margin({ right: DesignTokens.Spacing.SM })

      TextInput({ placeholder: 'æœç´¢æ—¥å¿—...', text: this.searchKeyword })
        .fontSize(DesignTokens.Typography.FONT_SIZE_SM)
        .fontColor(this.colors.TEXT_PRIMARY)
        .placeholderColor(this.colors.TEXT_TERTIARY)
        .backgroundColor(Color.Transparent)
        .layoutWeight(1)
        .height(36)
        .onChange((value: string) => {
          this.searchKeyword = value;
          this.refreshDisplayedLogs();
        })

      if (this.searchKeyword.length > 0) {
        Text('âœ•')
          .fontSize(DesignTokens.Typography.FONT_SIZE_BASE)
          .fontColor(this.colors.TEXT_TERTIARY)
          .onClick(() => {
            this.searchKeyword = '';
            this.refreshDisplayedLogs();
          })
      }
    }
    .width('100%')
    .height(44)
    .padding({ left: DesignTokens.Spacing.MD, right: DesignTokens.Spacing.MD })
    .backgroundColor(this.colors.BACKGROUND_SECONDARY)
    .borderRadius(DesignTokens.BorderRadius.MD)
    .margin({ bottom: DesignTokens.Spacing.SM })
  }

  @Builder
  private buildLogItem(entry: LogEntry) {
    Column() {
      Row() {
        Text(this.getLevelBadge(entry.level))
          .fontSize(DesignTokens.Typography.FONT_SIZE_XS)
          .fontColor(this.colors.WHITE)
          .backgroundColor(this.getLevelColor(entry.level))
          .borderRadius(4)
          .width(18)
          .height(18)
          .textAlign(TextAlign.Center)
          .margin({ right: DesignTokens.Spacing.SM })

        Text(this.formatTimestamp(entry.timestamp))
          .fontSize(DesignTokens.Typography.FONT_SIZE_XS)
          .fontColor(this.colors.TEXT_TERTIARY)
          .margin({ right: DesignTokens.Spacing.SM })

        if (entry.repeatCount > 1) {
          Text(`x${entry.repeatCount}`)
            .fontSize(DesignTokens.Typography.FONT_SIZE_XS)
            .fontColor(this.colors.WARNING)
            .margin({ right: DesignTokens.Spacing.SM })
        }

        Text(`[${entry.tag}]`)
          .fontSize(DesignTokens.Typography.FONT_SIZE_XS)
          .fontColor(this.colors.PRIMARY)
          .fontWeight(FontWeight.Medium)

        Blank()

        Text(entry.message)
          .fontSize(DesignTokens.Typography.FONT_SIZE_XS)
          .fontColor(this.colors.TEXT_PRIMARY)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .layoutWeight(1)
          .margin({ left: DesignTokens.Spacing.SM })
      }
      .width('100%')

      if (entry.data && entry.data.length > 0) {
        Text(entry.data)
          .fontSize(DesignTokens.Typography.FONT_SIZE_XS)
          .fontColor(this.colors.TEXT_SECONDARY)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ top: 4, left: 26 })
      }
    }
    .width('100%')
    .padding({ top: 8, bottom: 8 })
  }

  @Builder
  private buildLogList() {
    Column() {
      if (this.displayedLogs.length === 0) {
        Column() {
          Text('æš‚æ— æ—¥å¿—')
            .fontSize(DesignTokens.Typography.FONT_SIZE_BASE)
            .fontColor(this.colors.TEXT_TERTIARY)
        }
        .width('100%')
        .height(300)
        .justifyContent(FlexAlign.Center)
      } else {
        List({ space: 0 }) {
          ForEach(this.displayedLogs, (entry: LogEntry, index: number) => {
            ListItem() {
              this.buildLogItem(entry)
            }
          }, (entry: LogEntry) => `${entry.firstTimestamp}_${entry.timestamp}_${entry.level}_${entry.message}`)
        }
        .width('100%')
        .layoutWeight(1)
        .backgroundColor(this.colors.BACKGROUND_SECONDARY)
        .borderRadius(DesignTokens.BorderRadius.MD)
        .divider({
          strokeWidth: 1,
          color: this.colors.GRAY_100,
          startMargin: 0,
          endMargin: 0
        })
      }
    }
    .width('100%')
    .layoutWeight(1)
  }

  @Builder
  private buildActionButtons() {
    Row() {
      Button(this.isLogExporting ? 'å¯¼å‡ºä¸­...' : 'å¯¼å‡ºæ—¥å¿—')
        .fontSize(DesignTokens.Typography.FONT_SIZE_SM)
        .fontColor(this.colors.WHITE)
        .backgroundColor(this.isLogExporting ? this.colors.GRAY_400 : this.colors.PRIMARY)
        .borderRadius(DesignTokens.BorderRadius.MD)
        .height(36)
        .enabled(!this.isLogExporting)
        .onClick(() => { void this.exportLogs(); })

      Blank()

      Button(this.isDiagnosticExporting ? 'ç”Ÿæˆä¸­...' : 'è¯Šæ–­æŠ¥å‘Š')
        .fontSize(DesignTokens.Typography.FONT_SIZE_SM)
        .fontColor(this.colors.WHITE)
        .backgroundColor(this.isDiagnosticExporting ? this.colors.GRAY_400 : '#8B5CF6')
        .borderRadius(DesignTokens.BorderRadius.MD)
        .height(36)
        .enabled(!this.isDiagnosticExporting)
        .onClick(() => { void this.exportDiagnostic(); })

      Blank()

      Button('æ¸…ç©º')
        .fontSize(DesignTokens.Typography.FONT_SIZE_SM)
        .fontColor(this.colors.WHITE)
        .backgroundColor(this.colors.ERROR)
        .borderRadius(DesignTokens.BorderRadius.MD)
        .height(36)
        .onClick(() => { this.clearLogs(); })
    }
    .width('100%')
    .padding({ top: DesignTokens.Spacing.MD })
  }

  build() {
    Column() {
      this.buildHeader()

      Column() {
        this.buildStatsBar()
        this.buildPersistenceCard()
        this.buildFilterTabs()
        this.buildSearchBar()
        this.buildLogList()
        this.buildActionButtons()

        Text(`ç¼“å­˜ä¸Šé™: ${logger.getMaxCacheSize()} æ¡ | é¢„è§ˆæœ€è¿‘ ${this.PREVIEW_COUNT} æ¡`)
          .fontSize(DesignTokens.Typography.FONT_SIZE_XS)
          .fontColor(this.colors.TEXT_TERTIARY)
          .width('100%')
          .textAlign(TextAlign.Center)
          .padding({ top: DesignTokens.Spacing.SM })
      }
      .width('100%')
      .layoutWeight(1)
      .padding(DesignTokens.Spacing.MD)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.colors.BACKGROUND_PRIMARY)
  }
}
