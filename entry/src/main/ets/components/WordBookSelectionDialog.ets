/**
 * WordBookSelectionDialog - ËØç‰π¶ÈÄâÊã©ÂØπËØùÊ°Ü
 * Áî®‰∫éÈÄâÊã©Áî®Êà∑‰∏™‰∫∫ËØç‰π¶ÊàñÂàõÂª∫Êñ∞ËØç‰π¶
 */

import { UserStateManager, UserWordState } from '../manager/UserStateManager';
import { DBManager, UserWordBook } from '../database/DBManager';
import { BookCategory, BookDifficulty } from '../model/WordBookCatalog';
import { DesignTokens } from '../model/DesignTokens';

/**
 * ËØç‰π¶ÈÄâÊã©ÁªìÊûú
 */
export interface WordBookSelectionResult {
  success: boolean;
  selectedBookId?: string;
  error?: string;
}

/**
 * ËØç‰π¶ÈÄâÊã©ÂØπËØùÊ°ÜÁªÑ‰ª∂
 */
@Component
export struct WordBookSelectionDialog {
  @State private userWordBooks: UserWordBook[] = [];
  @State private showCreateForm: boolean = false;
  @State private newBookName: string = '';
  @State private newBookCategory: string = 'ÂÖ∂‰ªñ';
  @State private newBookDifficulty: string = 'ÂàùÁ∫ß';
  @State private newBookCover: string[] = ['#a8edea', '#fed6e3'];
  @State private isCreating: boolean = false;
  @State private selectedBookId: string = '';
  
  // ÂõûË∞ÉÂáΩÊï∞
  private onSelectionComplete?: (result: WordBookSelectionResult) => void;
  private onDismiss?: () => void;
  
  // ÁÆ°ÁêÜÂô®ÂÆû‰æã
  private dbManager: DBManager = DBManager.getInstance();
  private userStateManager: UserStateManager = UserStateManager.getInstance();
  
  aboutToAppear() {
    this.loadUserWordBooks();
  }
  
  /**
   * Âä†ËΩΩÁî®Êà∑‰∏™‰∫∫ËØç‰π¶
   */
  private async loadUserWordBooks(): Promise<void> {
    try {
      // ‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩÁî®Êà∑ÂàõÂª∫ÁöÑ‰∏™‰∫∫ËØç‰π¶
      const userBooks = await this.dbManager.getUserWordBooks();
      this.userWordBooks = userBooks.filter((book: UserWordBook): boolean => book.isUserCreated);
      
      console.log(`[WordBookSelectionDialog] Loaded ${this.userWordBooks.length} user word books`);
    } catch (error) {
      console.error('[WordBookSelectionDialog] Failed to load user word books:', error);
      this.userWordBooks = [];
    }
  }
  
  /**
   * ÂàõÂª∫Êñ∞ËØç‰π¶
   */
  private async createNewWordBook(): Promise<void> {
    if (this.newBookName.trim().length === 0) {
      this.showError('ËØ∑ËæìÂÖ•ËØç‰π¶ÂêçÁß∞');
      return;
    }
    
    if (this.newBookName.trim().length > 20) {
      this.showError('ËØç‰π¶ÂêçÁß∞‰∏çËÉΩË∂ÖËøá20‰∏™Â≠óÁ¨¶');
      return;
    }
    
    this.isCreating = true;
    
    try {
      const now = Date.now();
      const bookId = await this.dbManager.createUserWordBook(
        this.newBookName.trim(),
        'Áî®Êà∑Ëá™ÂÆö‰πâËØç‰π¶',
        this.newBookCategory,
        this.newBookDifficulty,
        JSON.stringify(this.newBookCover),
        'üìì'
      );

      const newBook: UserWordBook = {
        id: bookId,
        name: this.newBookName.trim(),
        description: 'Áî®Êà∑Ëá™ÂÆö‰πâËØç‰π¶',
        wordCount: 0,
        isUserCreated: true,
        createdAt: now,
        updatedAt: now,
        category: this.newBookCategory,
        difficulty: this.newBookDifficulty,
        coverColor: JSON.stringify(this.newBookCover),
        icon: 'üìì'
      };
      
      // Êõ¥Êñ∞Êú¨Âú∞ÂàóË°®
      this.userWordBooks.push(newBook);
      this.newBookName = '';
      this.showCreateForm = false;
      
      console.log(`[WordBookSelectionDialog] Created new word book: ${newBook.name}`);
      
      // Ëá™Âä®ÈÄâÊã©Êñ∞ÂàõÂª∫ÁöÑËØç‰π¶
      this.selectWordBook(newBook.id);
      
    } catch (error) {
      console.error('[WordBookSelectionDialog] Failed to create word book:', error);
      this.showError('ÂàõÂª∫ËØç‰π¶Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
    } finally {
      this.isCreating = false;
    }
  }
  
  /**
   * ÈÄâÊã©ËØç‰π¶
   */
  private selectWordBook(bookId: string): void {
    this.selectedBookId = bookId;
    
    // ÂÆåÊàêÈÄâÊã©
    if (this.onSelectionComplete) {
      this.onSelectionComplete({
        success: true,
        selectedBookId: bookId
      });
    }
    
    // ÂÖ≥Èó≠ÂØπËØùÊ°Ü
    if (this.onDismiss) {
      this.onDismiss();
    }
  }
  
  /**
   * ÂèñÊ∂àÈÄâÊã©
   */
  private cancelSelection(): void {
    if (this.onSelectionComplete) {
      this.onSelectionComplete({
        success: false,
        error: 'Áî®Êà∑ÂèñÊ∂à‰∫ÜÈÄâÊã©'
      });
    }
    
    if (this.onDismiss) {
      this.onDismiss();
    }
  }
  
  /**
   * ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
   */
  private showError(message: string): void {
    // ËøôÈáåÂèØ‰ª•ÈõÜÊàêÂà∞Áé∞ÊúâÁöÑÈîôËØØÊèêÁ§∫Á≥ªÁªü‰∏≠
    console.error(`[WordBookSelectionDialog] Error: ${message}`);
  }
  
  build() {
    Column() {
      // Ê†áÈ¢ò
      Row() {
        Text('ÈÄâÊã©ËØç‰π¶')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(DesignTokens.Colors.TEXT_PRIMARY)
        
        Blank()
        
        Text('‚úï')
          .fontSize(20)
          .fontColor(DesignTokens.Colors.TEXT_TERTIARY)
          .onClick(() => this.cancelSelection())
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 16, bottom: 16 })
      
      // ÂÜÖÂÆπÂå∫Âüü
      Stack() {
        if (this.showCreateForm) {
          // ÂàõÂª∫Êñ∞ËØç‰π¶Ë°®Âçï
          Column() {
            Text('ÂàõÂª∫Êñ∞ËØç‰π¶')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor(DesignTokens.Colors.TEXT_PRIMARY)
              .margin({ bottom: 16 })
            
            TextInput({ placeholder: 'ËØ∑ËæìÂÖ•ËØç‰π¶ÂêçÁß∞', text: this.newBookName })
              .width('100%')
              .height(48)
              .backgroundColor(DesignTokens.Colors.BACKGROUND_SECONDARY)
              .borderRadius(8)
              .padding({ left: 16, right: 16 })
              .maxLength(20)
              .onChange((value: string) => {
                this.newBookName = value;
              })
              .margin({ bottom: 16 })
            
            Row() {
              Text('ÂàÜÁ±ª: ').fontSize(14).fontColor(DesignTokens.Colors.TEXT_SECONDARY)
              Select([
                { value: 'ÂÖ∂‰ªñ' }, { value: 'ËÄÉËØï' }, { value: 'Â≠¶ÊúØ' }, 
                { value: 'ÂïÜÂä°' }, { value: 'ÊóÖÊ∏∏' }, { value: 'Êó•Â∏∏' }
              ])
              .selected(0)
              .value(this.newBookCategory)
              .font({ size: 14 })
              .onSelect((index, value) => this.newBookCategory = value)
              .height(36)
              
              Blank()
              
              Text('ÈöæÂ∫¶: ').fontSize(14).fontColor(DesignTokens.Colors.TEXT_SECONDARY)
              Select([
                { value: 'ÂÖ•Èó®' }, { value: 'ÂàùÁ∫ß' }, { value: '‰∏≠Á∫ß' }, 
                { value: 'È´òÁ∫ß' }, { value: '‰∏ìÂÆ∂' }
              ])
              .selected(1)
              .value(this.newBookDifficulty)
              .font({ size: 14 })
              .onSelect((index, value) => this.newBookDifficulty = value)
              .height(36)
            }
            .width('100%')
            .margin({ bottom: 20 })
            
            Row() {
              Button('ÂèñÊ∂à')
                .width(100)
                .height(40)
                .backgroundColor(DesignTokens.Colors.BACKGROUND_SECONDARY)
                .fontColor(DesignTokens.Colors.TEXT_SECONDARY)
                .onClick(() => {
                  this.showCreateForm = false;
                  this.newBookName = '';
                })
              
              Blank()
              
              Button(this.isCreating ? 'ÂàõÂª∫‰∏≠...' : 'Á°ÆËÆ§ÂàõÂª∫')
                .width(120)
                .height(40)
                .backgroundColor(DesignTokens.Colors.PRIMARY)
                .fontColor(DesignTokens.Colors.WHITE)
                .enabled(!this.isCreating)
                .onClick(() => this.createNewWordBook())
            }
            .width('100%')
          }
          .width('100%')
          .padding(20)
          
        } else {
          // ËØç‰π¶ÈÄâÊã©ÂàóË°®
          Column() {
            if (this.userWordBooks.length === 0) {
              // Á©∫Áä∂ÊÄÅ - ÂºïÂØºÂàõÂª∫
              Column() {
                Text('üìö')
                  .fontSize(48)
                  .margin({ bottom: 16 })
                
                Text('ËøòÊ≤°ÊúâÂàõÂª∫ËØç‰π¶')
                  .fontSize(16)
                  .fontColor(DesignTokens.Colors.TEXT_SECONDARY)
                  .margin({ bottom: 8 })
                
                Text('ÂàõÂª∫‰Ω†ÁöÑÁ¨¨‰∏Ä‰∏™ËØç‰π¶ÔºåÂºÄÂßãÊî∂ÈõÜÂçïËØçÂêßÔºÅ')
                  .fontSize(14)
                  .fontColor(DesignTokens.Colors.TEXT_TERTIARY)
                  .textAlign(TextAlign.Center)
                  .margin({ bottom: 24 })
                
                Button('ÂàõÂª∫ËØç‰π¶')
                  .width(160)
                  .height(44)
                  .backgroundColor(DesignTokens.Colors.PRIMARY)
                  .fontColor(DesignTokens.Colors.WHITE)
                  .borderRadius(22)
                  .onClick(() => this.showCreateForm = true)
              }
              .width('100%')
              .padding(40)
              .alignItems(HorizontalAlign.Center)
              
            } else {
              // ËØç‰π¶ÂàóË°®
              List() {
                ForEach(this.userWordBooks, (book: UserWordBook) => {
                  ListItem() {
                    Row() {
                      Column() {
                        Text(book.name)
                          .fontSize(16)
                          .fontWeight(FontWeight.Medium)
                        .fontColor(DesignTokens.Colors.TEXT_PRIMARY)
                          .maxLines(1)
                          .textOverflow({ overflow: TextOverflow.Ellipsis })
                          .width('100%')
                        
                        Text(`${book.wordCount} ËØç`)
                          .fontSize(14)
                        .fontColor(DesignTokens.Colors.TEXT_TERTIARY)
                          .margin({ top: 4 })
                      }
                      .layoutWeight(1)
                      .alignItems(HorizontalAlign.Start)
                      
                      Radio({ value: book.id, group: 'wordbook_selection' })
                        .checked(this.selectedBookId === book.id)
                        .onChange((isChecked: boolean) => {
                          if (isChecked) {
                            this.selectedBookId = book.id;
                          }
                        })
                    }
                    .width('100%')
                    .padding({ left: 20, right: 20, top: 16, bottom: 16 })
                    .backgroundColor(this.selectedBookId === book.id ? DesignTokens.Colors.PRIMARY_LIGHTEST : DesignTokens.Colors.SURFACE_PRIMARY)
                    .onClick(() => this.selectWordBook(book.id))
                  }
                }, (book: UserWordBook) => book.id)
              }
              .width('100%')
              .layoutWeight(1)
              .divider({ strokeWidth: 1, color: DesignTokens.Colors.BORDER_LIGHT })
              
              // ÂàõÂª∫Êñ∞ËØç‰π¶ÊåâÈíÆ
              Button('ÂàõÂª∫Êñ∞ËØç‰π¶')
                .width('90%')
                .height(44)
                .backgroundColor(Color.Transparent)
                .fontColor(DesignTokens.Colors.PRIMARY)
                .borderWidth(1)
                .borderColor(DesignTokens.Colors.PRIMARY)
                .borderRadius(22)
                .margin({ top: 16, bottom: 16 })
                .onClick(() => this.showCreateForm = true)
            }
          }
          .width('100%')
        }
      }
      .layoutWeight(1)
      .backgroundColor(DesignTokens.Colors.SURFACE_PRIMARY)
      
      // Â∫ïÈÉ®Êìç‰ΩúÊåâÈíÆ
      if (!this.showCreateForm && this.userWordBooks.length > 0) {
        Row() {
          Button('ÂèñÊ∂à')
            .layoutWeight(1)
            .height(48)
            .backgroundColor(DesignTokens.Colors.BACKGROUND_SECONDARY)
            .fontColor(DesignTokens.Colors.TEXT_SECONDARY)
            .margin({ right: 12 })
            .onClick(() => this.cancelSelection())
          
          Button('Á°ÆËÆ§ÈÄâÊã©')
            .layoutWeight(1)
            .height(48)
            .backgroundColor(this.selectedBookId ? DesignTokens.Colors.PRIMARY : DesignTokens.Colors.GRAY_300)
            .fontColor(DesignTokens.Colors.WHITE)
            .enabled(this.selectedBookId.length > 0)
            .onClick(() => {
              if (this.selectedBookId) {
                this.selectWordBook(this.selectedBookId);
              }
            })
        }
        .width('100%')
        .padding({ left: 20, right: 20, bottom: 20 })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(DesignTokens.Colors.SURFACE_PRIMARY)
    .borderRadius({ topLeft: 16, topRight: 16 })
  }
}
