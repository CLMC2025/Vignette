// =====================================================
// WordBookCatalog.ets - Built-in word book definitions
// =====================================================

import resourceManager from '@ohos.resourceManager';
import util from '@ohos.util';
import { WordDefinition, WordItem, WordStatus, FSRSState, ReviewHistory } from './WordModel';
import { GradientColorStop } from './TokenInterfaces';
import { BookImportParser } from '../utils/BookImportParser';
import { WordLevelLoader } from '../manager/WordLevelLoader';

export enum BookDifficulty {
  Intro = 'å…¥é—¨',
  Basic = 'åˆçº§',
  Intermediate = 'ä¸­çº§',
  Advanced = 'é«˜çº§',
  Expert = 'ä¸“å®¶'
}

export enum BookCategory {
  Exam = 'è€ƒè¯•',
  Academic = 'å­¦æœ¯',
  Business = 'å•†åŠ¡',
  Travel = 'æ—…æ¸¸',
  Daily = 'æ—¥å¸¸',
  Phrase = 'çŸ­è¯­',
  Kids = 'å°‘å„¿',
  Other = 'å…¶ä»–'
}

export class BookProgress {
  mastered: number;
  learning: number;
  newWords: number;

  constructor(mastered: number = 0, learning: number = 0, newWords: number = 0) {
    this.mastered = mastered;
    this.learning = learning;
    this.newWords = newWords;
  }
}

export class BookCategoryGradients {
  static readonly EXAM: GradientColorStop[] = [
    { color: '#667EEA', position: 0 },
    { color: '#764BA2', position: 1 }
  ];

  static readonly ACADEMIC: GradientColorStop[] = [
    { color: '#E6E9F0', position: 0 },
    { color: '#EEF1F5', position: 1 }
  ];

  static readonly BUSINESS: GradientColorStop[] = [
    { color: '#30CFD0', position: 0 },
    { color: '#330867', position: 1 }
  ];

  static readonly TRAVEL: GradientColorStop[] = [
    { color: '#5EE7DF', position: 0 },
    { color: '#B490CA', position: 1 }
  ];

  static readonly DAILY: GradientColorStop[] = [
    { color: '#FF9A9E', position: 0 },
    { color: '#FECFEF', position: 1 }
  ];

  static readonly PHRASE: GradientColorStop[] = [
    { color: '#84FAB0', position: 0 },
    { color: '#8FD3F4', position: 1 }
  ];

  static readonly KIDS: GradientColorStop[] = [
    { color: '#A18CD1', position: 0 },
    { color: '#FBC2EB', position: 1 }
  ];

  static readonly OTHER: GradientColorStop[] = [
    { color: '#a8edea', position: 0 },
    { color: '#fed6e3', position: 1 }
  ];

  static getByCategory(category: string): GradientColorStop[] {
    switch (category) {
      case 'è€ƒè¯•':
        return BookCategoryGradients.EXAM;
      case 'å­¦æœ¯':
        return BookCategoryGradients.ACADEMIC;
      case 'å•†åŠ¡':
        return BookCategoryGradients.BUSINESS;
      case 'æ—…æ¸¸':
        return BookCategoryGradients.TRAVEL;
      case 'æ—¥å¸¸':
        return BookCategoryGradients.DAILY;
      case 'çŸ­è¯­':
        return BookCategoryGradients.PHRASE;
      case 'å°‘å„¿':
        return BookCategoryGradients.KIDS;
      default:
        return BookCategoryGradients.OTHER;
    }
  }
}

export class BookDifficultyColors {
  static readonly INTRO: ResourceColor = '#4CAF50';
  static readonly BASIC: ResourceColor = '#8BC34A';
  static readonly INTERMEDIATE: ResourceColor = '#FF9800';
  static readonly ADVANCED: ResourceColor = '#F44336';
  static readonly EXPERT: ResourceColor = '#9C27B0';

  static getByDifficulty(difficulty: string): ResourceColor {
    switch (difficulty) {
      case 'å…¥é—¨':
        return BookDifficultyColors.INTRO;
      case 'åˆçº§':
        return BookDifficultyColors.BASIC;
      case 'ä¸­çº§':
        return BookDifficultyColors.INTERMEDIATE;
      case 'é«˜çº§':
        return BookDifficultyColors.ADVANCED;
      case 'ä¸“å®¶':
        return BookDifficultyColors.EXPERT;
      default:
        return BookDifficultyColors.BASIC;
    }
  }
}

export interface WordBookDefinition {
  id: string;
  name: string;
  hasUpdate: boolean;
  fileName: string;
  wordCount: number;
  source: string;
  description: string;
  difficulty: BookDifficulty;
  category: BookCategory;
  tags: string[];
  coverColor: string[];
  icon: string;
  estimatedDays: number;
  dailyGoal: number;
  levelTag?: string;
}

export const BuiltInWordBooks: WordBookDefinition[] = [
  {
    id: 'cet4',
    name: 'CET-4 æ ¸å¿ƒè¯æ±‡',
    hasUpdate: true,
    fileName: '',
    wordCount: 4544,
    source: 'KyleBing/english-vocabulary',
    description: 'å¤§å­¦è‹±è¯­å››çº§è€ƒè¯•æ ¸å¿ƒè¯æ±‡ï¼Œæ¶µç›–å¬åŠ›ã€é˜…è¯»ã€å†™ä½œå¸¸ç”¨è¯ã€‚',
    difficulty: BookDifficulty.Intermediate,
    category: BookCategory.Exam,
    tags: ['CET4', 'å¤§å­¦è‹±è¯­', 'è€ƒè¯•'],
    coverColor: ['#4FACFE', '#00F2FE'],
    icon: 'ðŸ“˜',
    estimatedDays: 60,
    dailyGoal: 100,
    levelTag: 'CET4'
  },
  {
    id: 'cet6',
    name: 'CET-6 æ ¸å¿ƒè¯æ±‡',
    hasUpdate: true,
    fileName: '',
    wordCount: 3991,
    source: 'KyleBing/english-vocabulary',
    description: 'å¤§å­¦è‹±è¯­å…­çº§è€ƒè¯•è¿›é˜¶è¯æ±‡ï¼Œæå‡é˜…è¯»ç†è§£ä¸Žé«˜çº§å†™ä½œèƒ½åŠ›ã€‚',
    difficulty: BookDifficulty.Advanced,
    category: BookCategory.Exam,
    tags: ['CET6', 'å¤§å­¦è‹±è¯­', 'è¿›é˜¶'],
    coverColor: ['#667EEA', '#764BA2'],
    icon: 'ðŸ“™',
    estimatedDays: 30,
    dailyGoal: 70,
    levelTag: 'CET6'
  },
  {
    id: 'kaoyan',
    name: 'è€ƒç ”è‹±è¯­é«˜é¢‘è¯æ±‡',
    hasUpdate: true,
    fileName: '',
    wordCount: 5047,
    source: 'KyleBing/english-vocabulary',
    description: 'ç ”ç©¶ç”Ÿå…¥å­¦è€ƒè¯•è‹±è¯­é«˜é¢‘è¯æ±‡ï¼Œé’ˆå¯¹æ€§çªç ´è€ƒç ”éš¾ç‚¹ã€‚',
    difficulty: BookDifficulty.Advanced,
    category: BookCategory.Exam,
    tags: ['è€ƒç ”', 'å‡å­¦', 'é«˜é¢‘'],
    coverColor: ['#FF9A9E', '#FECFEF'],
    icon: 'ðŸŽ“',
    estimatedDays: 15,
    dailyGoal: 60,
    levelTag: 'KAIOYAN'
  },
  {
    id: 'ielts',
    name: 'é›…æ€æ ¸å¿ƒè¯æ±‡',
    hasUpdate: true,
    fileName: '',
    wordCount: 5256,
    source: 'KyleBing/english-vocabulary',
    description: 'é›…æ€è€ƒè¯•å¿…å¤‡æ ¸å¿ƒè¯æ±‡ï¼Œè¦†ç›–å¬è¯´è¯»å†™å››é¡¹ã€‚',
    difficulty: BookDifficulty.Advanced,
    category: BookCategory.Exam,
    tags: ['IELTS', 'å‡ºå›½', 'ç•™å­¦'],
    coverColor: ['#89F7FE', '#66A6FF'],
    icon: 'ðŸŒ',
    estimatedDays: 45,
    dailyGoal: 70,
    levelTag: 'IELTS'
  },
  {
    id: 'toefl',
    name: 'æ‰˜ç¦æ ¸å¿ƒè¯æ±‡',
    hasUpdate: true,
    fileName: '',
    wordCount: 10367,
    source: 'KyleBing/english-vocabulary',
    description: 'æ‰˜ç¦è€ƒè¯•å­¦æœ¯è¯æ±‡ï¼Œæ”»å…‹åŒ—ç¾Žç•™å­¦è¯­è¨€å…³ã€‚',
    difficulty: BookDifficulty.Advanced,
    category: BookCategory.Exam,
    tags: ['TOEFL', 'åŒ—ç¾Ž', 'ç•™å­¦'],
    coverColor: ['#E0C3FC', '#8EC5FC'],
    icon: 'ðŸ—½',
    estimatedDays: 50,
    dailyGoal: 70,
    levelTag: 'TOEFL'
  },
  {
    id: 'gre',
    name: 'GREæ ¸å¿ƒè¯æ±‡',
    hasUpdate: true,
    fileName: '',
    wordCount: 10022,
    source: 'KyleBing/english-vocabulary',
    description: 'GREè€ƒè¯•é«˜éš¾åº¦è¯æ±‡ï¼ŒæŒ‘æˆ˜è¯æ±‡é‡å·…å³°ã€‚',
    difficulty: BookDifficulty.Expert,
    category: BookCategory.Exam,
    tags: ['GRE', 'ç ”ç©¶ç”Ÿ', 'å­¦æœ¯'],
    coverColor: ['#434343', '#000000'],
    icon: 'ðŸ§ ',
    estimatedDays: 60,
    dailyGoal: 50,
    levelTag: 'GRE'
  },
  {
    id: 'gmat',
    name: 'GMATæ ¸å¿ƒè¯æ±‡',
    hasUpdate: true,
    fileName: '',
    wordCount: 3312,
    source: 'KyleBing/english-vocabulary',
    description: 'GMATè€ƒè¯•è¯æ±‡ï¼Œå•†å­¦é™¢å…¥å­¦å¿…å¤‡ã€‚',
    difficulty: BookDifficulty.Expert,
    category: BookCategory.Exam,
    tags: ['GMAT', 'å•†ç§‘', 'MBA'],
    coverColor: ['#11998e', '#38ef7d'],
    icon: 'ðŸ“Š',
    estimatedDays: 40,
    dailyGoal: 60,
    levelTag: 'GMAT'
  },
  {
    id: 'sat',
    name: 'SATæ ¸å¿ƒè¯æ±‡',
    hasUpdate: true,
    fileName: '',
    wordCount: 4486,
    source: 'KyleBing/english-vocabulary',
    description: 'SATè€ƒè¯•æ ¸å¿ƒè¯æ±‡ï¼Œç¾Žå›½å¤§å­¦å…¥å­¦å¿…å¤‡ã€‚',
    difficulty: BookDifficulty.Advanced,
    category: BookCategory.Exam,
    tags: ['SAT', 'ç¾Žå›½', 'æœ¬ç§‘'],
    coverColor: ['#ee0979', '#ff6a00'],
    icon: 'ðŸŽ¯',
    estimatedDays: 35,
    dailyGoal: 60,
    levelTag: 'SAT'
  },
  {
    id: 'high',
    name: 'é«˜ä¸­è‹±è¯­è¯æ±‡',
    hasUpdate: true,
    fileName: '',
    wordCount: 5750,
    source: 'KyleBing/english-vocabulary',
    description: 'é«˜ä¸­è‹±è¯­è¯¾æ ‡è¯æ±‡ï¼Œé«˜è€ƒå¿…å¤‡ã€‚',
    difficulty: BookDifficulty.Intermediate,
    category: BookCategory.Exam,
    tags: ['é«˜ä¸­', 'é«˜è€ƒ', 'è¯¾æ ‡'],
    coverColor: ['#f093fb', '#f5576c'],
    icon: 'ðŸ“–',
    estimatedDays: 45,
    dailyGoal: 80,
    levelTag: 'HIGH'
  },
  {
    id: 'junior',
    name: 'åˆä¸­è‹±è¯­è¯æ±‡',
    hasUpdate: true,
    fileName: '',
    wordCount: 2481,
    source: 'KyleBing/english-vocabulary',
    description: 'åˆä¸­è‹±è¯­è¯¾æ ‡è¯æ±‡ï¼Œä¸­è€ƒå¿…å¤‡ã€‚',
    difficulty: BookDifficulty.Basic,
    category: BookCategory.Exam,
    tags: ['åˆä¸­', 'ä¸­è€ƒ', 'è¯¾æ ‡'],
    coverColor: ['#4facfe', '#00f2fe'],
    icon: 'ðŸ“•',
    estimatedDays: 30,
    dailyGoal: 70,
    levelTag: 'JUNIOR'
  },
  {
    id: 'primary',
    name: 'å°å­¦è‹±è¯­è¯æ±‡',
    hasUpdate: true,
    fileName: '',
    wordCount: 710,
    source: 'KyleBing/english-vocabulary',
    description: 'å°å­¦è‹±è¯­è¯¾æ ‡è¯æ±‡ï¼Œå¯è’™å¿…å¤‡ã€‚',
    difficulty: BookDifficulty.Intro,
    category: BookCategory.Kids,
    tags: ['å°å­¦', 'å¯è’™', 'åŸºç¡€'],
    coverColor: ['#a8edea', '#fed6e3'],
    icon: 'ðŸŒˆ',
    estimatedDays: 20,
    dailyGoal: 40,
    levelTag: 'PRIMARY'
  },
  {
    id: 'bec',
    name: 'å•†åŠ¡è‹±è¯­è¯æ±‡',
    hasUpdate: true,
    fileName: '',
    wordCount: 2832,
    source: 'KyleBing/english-vocabulary',
    description: 'èŒåœºå•†åŠ¡äº¤æµå¿…å¤‡è¯æ±‡ï¼Œæå‡ä¸“ä¸šå½¢è±¡ã€‚',
    difficulty: BookDifficulty.Intermediate,
    category: BookCategory.Business,
    tags: ['BEC', 'èŒåœº', 'å•†åŠ¡'],
    coverColor: ['#30CFD0', '#330867'],
    icon: 'ðŸ’¼',
    estimatedDays: 30,
    dailyGoal: 70,
    levelTag: 'BEC'
  }
];

function uint8ArrayToString(uint8Array: Uint8Array): string {
  const decoder = new util.TextDecoder('utf-8');
  return decoder.decode(uint8Array);
}

function normalizeWordList(words: string[]): string[] {
  const cleaned = words
    .map((word: string): string => word.trim().toLowerCase())
    .filter((word: string): boolean => word.length > 0);

  const seen = new Set<string>();
  const unique: string[] = [];
  for (const word of cleaned) {
    if (!seen.has(word)) {
      seen.add(word);
      unique.push(word);
    }
  }
  return unique;
}

export async function loadWordBookWords(
  resourceMgr: resourceManager.ResourceManager,
  book: WordBookDefinition
): Promise<string[]> {
  const totalStart = Date.now();
  if (book.levelTag && book.levelTag.length > 0) {
    const levelLoader = WordLevelLoader.getInstance();
    levelLoader.setResourceManager(resourceMgr);
    const initStart = Date.now();
    await levelLoader.initialize();
    const initElapsed = Date.now() - initStart;
    const getStart = Date.now();
    const words = levelLoader.getWordsByLevel(book.levelTag);
    const getElapsed = Date.now() - getStart;
    const totalElapsed = Date.now() - totalStart;
    console.info(`[loadWordBookWords] Level ${book.levelTag}: init=${initElapsed}ms, getWords=${getElapsed}ms, total=${totalElapsed}ms, count=${words.length}`);
    return words;
  }
  
  if (!book.fileName || book.fileName.length === 0) {
    return [];
  }
  
  const uint8Array = await resourceMgr.getRawFileContent(book.fileName);
  const content = uint8ArrayToString(uint8Array);
  const words = content.split(/\r?\n/);
  return normalizeWordList(words);
}

export async function buildWordItemsForBook(
  book: WordBookDefinition,
  resourceMgr: resourceManager.ResourceManager
): Promise<WordItem[]> {
  if (book.levelTag && book.levelTag.length > 0) {
    const levelLoader = WordLevelLoader.getInstance();
    levelLoader.setResourceManager(resourceMgr);
    await levelLoader.initialize();
    const words = levelLoader.getWordsByLevel(book.levelTag);
    
    const now = Date.now();
    const items: WordItem[] = [];
    for (let i = 0; i < words.length; i++) {
      const word = words[i];
      const def = new WordDefinition(word, '', '', '', [], 'import');
      items.push(new WordItem(
        0,
        word,
        WordStatus.NEW,
        new FSRSState(),
        new ReviewHistory(),
        def,
        now,
        now,
        now,
        book.id,
        book.tags
      ));
    }
    return items;
  }
  
  if (!book.fileName || book.fileName.length === 0) {
    return [];
  }
  
  const uint8Array = await resourceMgr.getRawFileContent(book.fileName);
  const content = uint8ArrayToString(uint8Array);
  const result = BookImportParser.parseText(content, book.id, book.tags);
  return result.words;
}
