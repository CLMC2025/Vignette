import preferences from '@ohos.data.preferences';
import type common from '@ohos.app.ability.common';
import { GuideStep, GuideCategory, OnboardingState } from '../model/GuideModels';

export class GuideManager {
  private static readonly PREFERENCES_NAME: string = 'guide_store';
  private static readonly ONBOARDING_STATE_KEY: string = 'onboarding_state_v2';
  private static instance: GuideManager | null = null;

  private prefs: preferences.Preferences | null = null;
  private context: common.UIAbilityContext | null = null;

  private constructor() {}

  static getInstance(): GuideManager {
    if (GuideManager.instance === null) {
      GuideManager.instance = new GuideManager();
    }
    return GuideManager.instance;
  }

  injectContext(context: common.UIAbilityContext): void {
    this.context = context;
  }

  async initialize(): Promise<boolean> {
    if (this.context === null) {
      return false;
    }
    try {
      this.prefs = await preferences.getPreferences(this.context, GuideManager.PREFERENCES_NAME);
      return true;
    } catch (e) {
      return false;
    }
  }

  async getOnboardingState(): Promise<OnboardingState> {
    if (this.prefs === null) {
      return this.getDefaultState();
    }
    try {
      const json = await this.prefs.get(GuideManager.ONBOARDING_STATE_KEY, '');
      if (typeof json === 'string' && json.length > 0) {
        return JSON.parse(json) as OnboardingState;
      }
    } catch (e) {}
    return this.getDefaultState();
  }

  async setOnboardingSeen(seen: boolean): Promise<void> {
    const state = await this.getOnboardingState();
    state.hasSeenOnboarding = seen;
    if (seen && state.completedAt === null) {
      state.completedAt = Date.now();
    }
    await this.saveState(state);
  }

  async completeStep(stepId: string): Promise<void> {
    const state = await this.getOnboardingState();
    if (!state.completedSteps.includes(stepId)) {
      state.completedSteps.push(stepId);
    }
    await this.saveState(state);
  }

  async skipOnboarding(): Promise<void> {
    const state = await this.getOnboardingState();
    state.skippedAt = Date.now();
    state.hasSeenOnboarding = true;
    await this.saveState(state);
  }

  async completeOnboarding(): Promise<void> {
    const state = await this.getOnboardingState();
    state.hasSeenOnboarding = true;
    state.completedAt = Date.now();
    await this.saveState(state);
  }

  private async saveState(state: OnboardingState): Promise<void> {
    if (this.prefs === null) {
      return;
    }
    try {
      await this.prefs.put(GuideManager.ONBOARDING_STATE_KEY, JSON.stringify(state));
      await this.prefs.flush();
    } catch (e) {}
  }

  private getDefaultState(): OnboardingState {
    return {
      hasSeenOnboarding: false,
      completedSteps: [],
      skippedAt: null,
      completedAt: null
    };
  }

  getGuideSteps(): GuideStep[] {
    return [
      {
        id: 'welcome',
        stepNo: 1,
        icon: 'ðŸ‘‹',
        title: 'æ¬¢è¿Žä½¿ç”¨ Vignette',
        description: 'æ‚¨çš„æ™ºèƒ½è‹±è¯­è¯æ±‡å­¦ä¹ åŠ©æ‰‹',
        detail: 'Vignette é‡‡ç”¨ FSRS è®°å¿†ç®—æ³•ï¼Œç»“åˆè¯­å¢ƒå­¦ä¹ ï¼Œå¸®åŠ©æ‚¨é«˜æ•ˆè®°å¿†è‹±è¯­å•è¯ã€‚è®©æˆ‘ä»¬å¼€å§‹äº†è§£å¦‚ä½•ä½¿ç”¨å§ï¼',
        category: 'general'
      },
      {
        id: 'select_book',
        stepNo: 2,
        icon: 'ðŸ“–',
        title: 'é€‰æ‹©è¯ä¹¦',
        description: 'é€‰æ‹©é€‚åˆæ‚¨çš„è¯ä¹¦å¼€å§‹å­¦ä¹ ',
        detail: 'åœ¨é¦–é¡µç‚¹å‡»è¯ä¹¦å¡ç‰‡ï¼Œé€‰æ‹© CET4ã€GREã€é«˜è€ƒç­‰å†…ç½®è¯ä¹¦ï¼Œæˆ–å¯¼å…¥è‡ªå®šä¹‰è¯ä¹¦ã€‚é€‰æ‹©åŽç‚¹å‡»"å¼€å§‹å­¦ä¹ "è¿›å…¥ä»Šæ—¥ä»»åŠ¡ã€‚',
        category: 'wordbook'
      },
      {
        id: 'learning_session',
        stepNo: 3,
        icon: 'ðŸ“š',
        title: 'å­¦ä¹ ä»»åŠ¡',
        description: 'å®Œæˆæ¯æ—¥å­¦ä¹ ä¸Žå¤ä¹ ä»»åŠ¡',
        detail: 'ç³»ç»Ÿä¼šæ ¹æ® FSRS ç®—æ³•å®‰æŽ’æ–°è¯å­¦ä¹ å’Œæ—§è¯å¤ä¹ ã€‚æ¯ä¸ªå•è¯ä¼šå±•ç¤ºè¯­å¢ƒæ•…äº‹ï¼Œå¸®åŠ©æ‚¨åœ¨åœºæ™¯ä¸­ç†è§£è®°å¿†ã€‚',
        category: 'learning'
      },
      {
        id: 'tap_word',
        stepNo: 4,
        icon: 'ðŸ‘†',
        title: 'ç‚¹è¯æŸ¥ä¹‰',
        description: 'ç‚¹å‡»å•è¯æŸ¥çœ‹é‡Šä¹‰å’Œè¯­å¢ƒ',
        detail: 'é˜…è¯»è¯­å¢ƒæ—¶ï¼Œç‚¹å‡»ä»»æ„å•è¯å¯æŸ¥çœ‹è¯¦ç»†é‡Šä¹‰ã€éŸ³æ ‡ã€ä¾‹å¥ã€‚æ”¯æŒæ”¶è—åˆ°å•è¯æœ¬ï¼Œæ–¹ä¾¿åŽç»­å¤ä¹ ã€‚',
        category: 'learning'
      },
      {
        id: 'mark_known',
        stepNo: 5,
        icon: 'âœ…',
        title: 'æ ‡è®°å·²çŸ¥',
        description: 'å·²æŽŒæ¡çš„å•è¯å¯å‡å°‘å¤ä¹ ',
        detail: 'å¦‚æžœæŸä¸ªå•è¯æ‚¨å·²ç»æŽŒæ¡ï¼Œå¯ä»¥"æ ‡è®°å·²çŸ¥"ï¼Œç³»ç»Ÿä¼šå‡å°‘è¯¥å•è¯çš„å¤ä¹ é¢‘çŽ‡ã€‚éœ€è¦æ—¶å¯åœ¨è¯è¡¨æˆ–è¯¦æƒ…é¡µ"æ¢å¤å­¦ä¹ "ã€‚',
        category: 'learning'
      },
      {
        id: 'notebook',
        stepNo: 6,
        icon: 'â­',
        title: 'å•è¯æœ¬æ”¶è—',
        description: 'æ”¶è—é‡ç‚¹å•è¯ä¾¿äºŽå¤ä¹ ',
        detail: 'æ”¶è—åŠŸèƒ½è®©æ‚¨å»ºç«‹ä¸ªäººé‡ç‚¹å•è¯æ¸…å•ã€‚æ”¶è—çš„å•è¯ä¼šåœ¨å•è¯æœ¬ä¸­æ˜¾ç¤ºï¼Œæ–¹ä¾¿é›†ä¸­å¤ä¹ å’ŒæŸ¥é˜…ã€‚',
        category: 'learning'
      },
      {
        id: 'text_library',
        stepNo: 7,
        icon: 'ðŸ“',
        title: 'æ–‡æœ¬åº“é˜…è¯»',
        description: 'å¯¼å…¥æ–‡ç« åœ¨é˜…è¯»ä¸­å­¦ä¹ ',
        detail: 'åœ¨æ–‡æœ¬åº“é¡µé¢å¯¼å…¥ txt æ–‡ä»¶æˆ–ç²˜è´´æ–‡ç« å†…å®¹ï¼Œé˜…è¯»æ—¶ç‚¹å‡»å•è¯æŸ¥é‡Šä¹‰å¹¶æ”¶è—ã€‚è®©å­¦ä¹ èžå…¥çœŸå®žé˜…è¯»åœºæ™¯ã€‚',
        category: 'text'
      },
      {
        id: 'settings',
        stepNo: 8,
        icon: 'âš™ï¸',
        title: 'ä¸ªæ€§åŒ–è®¾ç½®',
        description: 'è°ƒæ•´å­¦ä¹ å‚æ•°å’Œåå¥½',
        detail: 'åœ¨è®¾ç½®é¡µé¢å¯ä»¥é…ç½®æ¯æ—¥ä»»åŠ¡é‡ã€å­¦ä¹ éš¾åº¦ã€è¯­å¢ƒé£Žæ ¼ã€è¯­éŸ³æœ—è¯»ç­‰ã€‚è¿˜å¯ä»¥é…ç½® API æŽ¥å£å’Œ WebDAV åŒæ­¥ã€‚',
        category: 'settings'
      },
      {
        id: 'sync',
        stepNo: 9,
        icon: 'â˜ï¸',
        title: 'æ•°æ®åŒæ­¥',
        description: 'äº‘ç«¯å¤‡ä»½å­¦ä¹ è¿›åº¦',
        detail: 'æ”¯æŒ WebDAV äº‘åŒæ­¥ï¼Œå¯åœ¨å¤šè®¾å¤‡é—´åŒæ­¥å­¦ä¹ è¿›åº¦å’Œè¯ä¹¦æ•°æ®ã€‚å®šæœŸå¤‡ä»½ï¼Œæ•°æ®ä¸ä¸¢å¤±ã€‚',
        category: 'settings'
      },
      {
        id: 'help',
        stepNo: 10,
        icon: 'ðŸŽ‰',
        title: 'å‡†å¤‡å°±ç»ª',
        description: 'å¼€å¯ä½ çš„è¯æ±‡å­¦ä¹ ä¹‹æ—…',
        detail: 'é€‰æ‹©è¯ä¹¦åŽç‚¹å‡»"å¼€å§‹å­¦ä¹ "å³å¯å¼€å§‹ã€‚é¦–é¡µ"å•è¯æœ¬"å¯æŸ¥çœ‹æ”¶è—çš„å•è¯ã€‚ç¥å­¦ä¹ æ„‰å¿«ï¼',
        category: 'general'
      }
    ];
  }

  getStepsByCategory(category: GuideCategory): GuideStep[] {
    return this.getGuideSteps().filter((step: GuideStep) => step.category === category);
  }
}
