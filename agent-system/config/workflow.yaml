# AI 代理工作流配置

> 本文件定义AI代理的工作流程和执行规则。

---

## 代理类型

### 1. 初始化代理 (Initializer Agent)
- **触发条件**：首次运行或需要重新规划时
- **提示模板**：agent-system/initializer/init-agent.md
- **职责**：
  - 项目分析
  - 需求分解
  - 环境设置
  - 基线验证

### 2. 编码代理 (Coding Agent)
- **触发条件**：日常开发会话
- **提示模板**：agent-system/coder/coding-agent.md
- **职责**：
  - 增量开发
  - 功能实现
  - 测试编写
  - 状态更新

---

## 工作流程

```yaml
workflow:
  name: "Vignette Development Workflow"
  version: "1.0"
  
  phases:
    - name: "initialization"
      agent: "initializer"
      triggers:
        - "first_run"
        - "major_refactor"
        - "requirements_change"
      steps:
        - "analyze_project"
        - "decompose_requirements"
        - "create_tracking_files"
        - "verify_baseline"
      outputs:
        - "feature-list.md"
        - "ai-progress.txt"
        - "session-context.md"
    
    - name: "development"
      agent: "coder"
      triggers:
        - "regular_session"
      steps:
        - "read_context"
        - "select_feature"
        - "implement_feature"
        - "verify_implementation"
        - "update_tracking"
      max_features_per_session: 3
      
    - name: "ai_integration"
      agent: "coder"
      triggers:
        - "ai_related_features"
      steps:
        - "read_context"
        - "setup_ai_service"
        - "implement_ai_features"
        - "test_ai_integration"
        - "update_tracking"
      max_features_per_session: 2
      
    - name: "verification"
      agent: "coder"
      triggers:
        - "feature_completed"
      steps:
        - "run_tests"
        - "check_code_style"
        - "update_status"
```

---

## 会话规则

### 时间管理
```yaml
session:
  max_duration: "context_window_limit"
  checkpoint_interval: "per_feature"
  
  time_allocation:
    context_reading: "5%"
    implementation: "70%"
    testing: "15%"
    documentation: "10%"
```

### 功能选择策略
```yaml
feature_selection:
  priority_order:
    1: "blocked_features"
    2: "P0_features"
    3: "P1_features"
    4: "P2_features"
    5: "P3_features"
  
  dependency_check: true
  continue_unfinished: true
  
  max_concurrent: 1
  preferred_batch_size: 1-3
  
  ai_features_priority:
    - "F-001"
    - "F-006"
    - "F-002"
    - "F-003"
```

### 状态转换
```yaml
state_transitions:
  pending:
    next: "in_progress"
    condition: "selected_for_implementation"
    
  in_progress:
    next: 
      - "completed"
      - "blocked"
    condition:
      completed: "all_acceptance_criteria_met"
      blocked: "unresolvable_issue"
      
  completed:
    next: "verified"
    condition: "tests_passed"
    
  verified:
    next: null
    condition: "final_state"
    
  blocked:
    next: "in_progress"
    condition: "blocking_issue_resolved"
```

---

## 质量门禁

### 代码提交前检查
```yaml
quality_gates:
  pre_commit:
    - name: "compilation"
      command: "build"
      required: true
      
    - name: "type_check"
      command: "typecheck"
      required: true
      
    - name: "lint"
      command: "lint"
      required: true
      allow_warnings: false
      
    - name: "unit_tests"
      command: "test"
      required: true
      min_coverage: 0
  
  ai_features:
    - name: "ai_service_availability"
      description: "AI服务可用性"
      required: true
      
    - name: "context_quality"
      description: "语境生成质量"
      required: true
      
    - name: "algorithm_integration"
      description: "FSRS算法集成"
      required: true
      
    - name: "ui_animation"
      description: "UI动效流畅"
      required: true
```

### 会话结束检查
```yaml
session_end_checks:
  - "tracking_files_updated"
  - "code_compiles"
  - "tests_pass"
  - "no_uncommitted_changes"
  - "next_steps_documented"
```

---

## 错误处理

### 阻塞处理
```yaml
blocking_handling:
  actions:
    - "mark_feature_blocked"
    - "document_blocking_reason"
    - "suggest_workaround"
    - "select_alternative_feature"
  
  escalation:
    after_sessions: 3
    action: "request_human_intervention"
```

### 回滚策略
```yaml
rollback:
  trigger:
    - "critical_bug_introduced"
    - "tests_fail_unexpectedly"
    
  actions:
    - "revert_changes"
    - "restore_previous_state"
    - "document_issue"
```

---

## 文件更新规则

### feature-list.md
```yaml
update_rules:
  - trigger: "feature_started"
    action: "set_status_in_progress"
    
  - trigger: "feature_completed"
    action: "set_status_completed"
    
  - trigger: "feature_verified"
    action: "set_status_verified"
    
  - trigger: "feature_blocked"
    action: "set_status_blocked"
    additional: "add_blocking_reason"
```

### ai-progress.txt
```yaml
update_rules:
  - trigger: "session_start"
    action: "create_session_entry"
    
  - trigger: "feature_completed"
    action: "add_completion_record"
    
  - trigger: "session_end"
    action: "add_summary"
```

### session-context.md
```yaml
update_rules:
  - trigger: "session_end"
    action: "update_recent_sessions"
    
  - trigger: "priority_change"
    action: "update_priority_queue"
    
  - trigger: "blocking_change"
    action: "update_blocking_items"
```

---

## 配置版本

- **版本**：1.0
- **创建日期**：2025-02-13
- **最后更新**：2025-02-13
